---
description: >
  Cursor 专用 Python 编码与协作规则。
  目标：写清晰、可维护、可测试、不乱改、不跳步骤的 Python 代码。
globs: "**/*.py"
alwaysApply: true
---

---

## 一、全局硬规则（最高优先级）

- **始终使用中文回复**
- **禁止跳步骤直接改代码**
- **禁止未阅读完整相关代码就开始修改**
- **禁止大规模重构，除非我明确同意**
- **默认只做最小化修改**

---

## 二、代码基础规范（新代码 / 自动补全）

### 2.1 编码规范

- 严格遵循 **PEP 8**
- 公共函数 / 类 / 模块 **必须有 docstring**
- 尽量使用 **类型注解（typing）**
- 函数要求：
  - 单一职责
  - 行数 ≤ 50
  - 不产生隐藏副作用

---

### 2.2 代码风格

- 优先使用：
  - 列表 / 字典 / 集合推导式（不过度）
  - 生成器（大数据量场景）
  - `with` 管理资源
- 禁止：
  - 复制粘贴式代码
  - 魔法数字
  - 隐式修改全局状态

---

## 三、环境与依赖（强制）

- **统一使用 uv**
  - ❌ 禁止 `pip install`
  - ❌ 禁止直接 `python xxx.py`
  - ✅ 使用 `uv run xxx`
- 依赖统一写在 `pyproject.toml`
- 开发 / 测试 / 生产环境依赖必须一致
- 默认假设代码会执行 `make run`

---

## 四、数据与模型定义

- 数据模型必须使用：
  - `@dataclass`
  - 或 `pydantic`
- 禁止：
  - 未定义结构的 dict
  - 通过 key 猜字段语义
- 数据模型及相关查询操作必须遵守:
  - SQLAlchemy 2.0 规范

---

## 五、异常、日志与健壮性

- 禁止裸 `except:`
- 异常必须：
  - 捕获明确
  - 语义清晰
- 关键路径必须记录日志：
  - `error`：错误
  - `info`：重要状态变化
- 日志必须有排错价值

---

## 六、测试与结果说明（强制）

- 使用 **pytest**
- 新功能 / Bug 修复：
  - 必须补测试
- 每次修改后：
  - **假定至少 10 条输入 case**
  - 给出对应的 **预期结果**
- 每次测试通过后:
  - 删除测试用例

---

## 七、解释与交流规则（Cursor 高频场景）

### 7.1 解释代码时

- **说人话**
- 少用术语
- 必须结合实际代码说明
- 复杂逻辑：
  - **必须给 Mermaid 图**

---

### 7.2 Mermaid 强规则

- 语法必须自检
- 必须可被渲染
- 必须在 **暗黑主题** 下清晰可见
- 推荐类型：
  - `flowchart`
  - `sequenceDiagram`
  - `classDiagram`

---

## 八、修改 / 重构规则（重点）

### 修改前（必须）

- 明确说明：
  - 改哪里
  - 不改哪里
  - 为什么要改

---

### 修改原则

- **最小化修改**
- 不影响无关模块
- 不引入新依赖
- 不改变既有接口行为（除非说明）

---

### 修改后（必须）

- 列出：
  - 改动点清单
  - 潜在副作用
- 给出：
  - 10 条 case
  - 对应预期结果

---

## 九、Bug 修复专用流程（强制）

当被要求 **修 Bug / 排查问题** 时，禁止直接给代码。

### 必须严格按以下步骤：

1. **理解问题（Understand）**
   - 复述 Bug 现象
   - 指出影响范围

2. **分析原因（Analyze）**
   - 至少 2 种可能根因
   - 每种说明触发条件

3. **修复计划（Plan）**
   - 验证方式
   - 修复思路
   - 是否影响其他模块

4. **请求确认（Confirm）**
   - 等待确认后再动手

5. **执行修复（Execute）**

6. **自检（Review）**
   - 是否引入新问题

7. **说明（Explain）**
   - 改了什么
   - 为什么这么改

---

## 十、Cursor 行为总结

- Cursor 不是自由发挥模式
- Cursor 必须像一个谨慎的高级工程师：
  - 先理解
  - 再计划
  - 再修改
  - 最后解释

---

**始终使用中文回复。**
